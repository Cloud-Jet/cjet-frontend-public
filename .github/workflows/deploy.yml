name: Deploy CloudJet Frontend to S3 and CloudFront

on:
  push:
    branches: [ main, production, frontend/ch ]
    paths: 
      - '**'
  workflow_dispatch:

env:
  AWS_REGION: 'ap-northeast-2'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup environment
      run: |
        echo "Setting up deployment environment..."
        echo "AWS Region: ${{ env.AWS_REGION }}"
        echo "Environment ready for deployment"
        
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: Set environment variables
      run: |
        # ê¸°ì¡´ S3 ë²„í‚· ì‚¬ìš©
        echo "DEPLOY_ENV=production" >> $GITHUB_ENV
        echo "S3_BUCKET=cloudjet-id-frontend-hosting" >> $GITHUB_ENV
        echo "CLOUDFRONT_DISTRIBUTION_ID=${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}" >> $GITHUB_ENV
        
    - name: Build frontend
      run: |
        echo "Frontend build completed - Static files ready for deployment"
        echo "Environment: $DEPLOY_ENV"
        echo "S3 Bucket: $S3_BUCKET"
        
    - name: Optimize static files
      run: |
        echo "Starting static file optimization..."
        
        # CSS íŒŒì¼ ìµœì í™”
        if [ -d "css" ]; then
          find css -name "*.css" -type f -exec gzip -k {} \;
          echo "CSS files optimized with gzip"
        else
          echo "CSS directory not found, skipping CSS optimization"
        fi
        
        # JS íŒŒì¼ ìµœì í™”  
        if [ -d "js" ]; then
          find js -name "*.js" -type f -exec gzip -k {} \;
          echo "JS files optimized with gzip"
        else
          echo "JS directory not found, skipping JS optimization"
        fi
        
        # HTML íŒŒì¼ ìµœì í™”
        find . -name "*.html" -type f -exec gzip -k {} \;
        echo "HTML files optimized with gzip"
        
        echo "Static file optimization completed successfully!"
        
    - name: Deploy to S3
      run: |
        echo "Starting S3 deployment to bucket: $S3_BUCKET"
        
        # S3 ë™ê¸°í™” (ìºì‹œ í—¤ë” ì„¤ì • í¬í•¨)
        aws s3 sync . s3://$S3_BUCKET \
          --delete \
          --exclude "*.git*" \
          --exclude ".github/*" \
          --exclude "README.md" \
          --exclude "*.md" \
          --exclude "setup-github.md" \
          --cache-control "max-age=31536000" \
          --metadata-directive REPLACE
        
        echo "S3 sync completed"
        
        # HTML íŒŒì¼ì€ ì§§ì€ ìºì‹œ ì„¤ì •
        aws s3 cp . s3://$S3_BUCKET \
          --recursive \
          --exclude "*" \
          --include "*.html" \
          --cache-control "max-age=300" \
          --content-type "text/html" \
          --metadata-directive REPLACE
        
        echo "HTML files cache updated"
        
        # CSS/JS íŒŒì¼ì€ ì¤‘ê°„ ìºì‹œ ì„¤ì •
        aws s3 cp . s3://$S3_BUCKET \
          --recursive \
          --exclude "*" \
          --include "*.css" \
          --include "*.js" \
          --cache-control "max-age=86400" \
          --metadata-directive REPLACE
        
        echo "CSS/JS files cache updated"
        echo "S3 deployment completed successfully!"
        
    - name: Invalidate CloudFront
      run: |
        # ì „ì²´ ìºì‹œ ë¬´íš¨í™” (ë¹„ìš© ê³ ë ¤í•˜ì—¬ íŠ¹ì • ê²½ë¡œë§Œ ì„¤ì • ê°€ëŠ¥)
        aws cloudfront create-invalidation \
          --distribution-id $CLOUDFRONT_DISTRIBUTION_ID \
          --paths "/*"
          
        echo "CloudFront cache invalidation initiated"
        
    - name: Deployment Summary
      run: |
        echo "ğŸš€ Deployment Summary"
        echo "Environment: $DEPLOY_ENV"
        echo "S3 Bucket: $S3_BUCKET"
        echo "CloudFront Distribution: $CLOUDFRONT_DISTRIBUTION_ID"
        echo "âœ… Deployment completed successfully!"
        
        echo "ğŸŒ CloudFront URL: https://d7aq35kj9vr3c.cloudfront.net"
        echo "ğŸŒ Custom Domain: https://www.cloudjet.click"
        echo "ğŸ“ CloudFront ë°°í¬ ì™„ë£Œê¹Œì§€ 5-10ë¶„ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
